<html>
<head>
  <title>dontno game</title>
  <script src="js/jquery-2.1.3.min.js"></script>
  <script src="js/js-yaml-3.2.6.min.js"></script>
  <script src="js/underscore-1.7.0.min.js"></script>
  <script src="js/velocity-1.2.2/velocity.min.js"></script>
  <script src="js/velocity-1.2.2/velocity.ui.min.js"></script>
  <link type="text/cfg.yaml" src="cfg.yaml"></link>
</head>
<body>
  <div class="main" id="main0">
    <stage id="stage0">
      <world>
        <tiles></tiles>
        <critters></critters>
        <bolts></bolts>
      </world>
    </stage>
  </div>

  <div class="main" id="main1">
    <stage id="stage1">
      <world>
        <tiles></tiles>
        <critters></critters>
        <bolts></bolts>
      </world>
    </stage>
  </div>
</body>

<script>
var wantKeys = _.object(_.map("WASDIJKL".split(""),
  function(c) { return [c.charCodeAt(0), c.toLowerCase()]; }));

var cmdKeysWASD = { w: 'up', a: 'left', s: 'down', d: 'right' };
var cmdKeysIJKL = { i: 'up', j: 'left', k: 'down', l: 'right' };

var curKeys = {};
var curKeysChanged = []; // Registered callbacks.

function curKeysEvent(keyDown, event) {
  for (var i = 0; i < curKeysChanged.length; i++) {
    curKeysChanged[i](curKeys, keyDown, event);
  }
}

$(document).ready(function() {
  $("body").keydown(function(event) {
    var k = wantKeys[event.which];
    if (k && !curKeys[k]) {
      curKeys[k] = event;
      curKeysEvent(true, event);
    }
  });

  $("body").keyup(function(event) {
    var k = wantKeys[event.which];
    if (k && curKeys[k]) {
      delete curKeys[wantKeys[event.which]];
      curKeysEvent(false, event);
    }
  });

  loadCfgs(function(cfg) {
    runMap(cfg, "stage0", "home", curKeys, cmdKeysWASD);
    runMap(cfg, "stage1", "cave-of-fancy", curKeys, cmdKeysIJKL);
  });
});

// ------------------------------------------------------------

function loadCfgs(successCallback) {
  var cfgsHave = {};
  var cfgsWant = $("link[type='text/cfg.yaml']");
  cfgsWant.each(function(i, el) {
    var src = $(el).attr("src");
    $.ajax({
      url: src,
      dataType: "text",
      success: function(data) {
        cfgsHave[src] = jsyaml.safeLoad(data, {filename: src});
        if (_.size(cfgsHave) >= _.size(cfgsWant)) {
          var merged = {}
          _.each(cfgsHave, function(cfg) {
            _.each(cfg, function(v, k) {
              merged[k] = _.defaults(merged[k] || {}, v);
            });
          });
          successCallback(merged);
        }
      },
      error: function() { console.log("error: loadCfgs", arguments); }
    });
  });
}

// ------------------------------------------------------------

function runMap(cfg, stageId, mapName, curKeys, cmdKeys) {
  var stageEl = $("#" + stageId).first();
  var stagePos = stageEl.position();

  var stagePointerX = 300;
  var stagePointerY = 300;
  stageEl.mousemove(function(event) {
    stagePointerX = event.pageX - stagePos.left;
    stagePointerY = event.pageY - stagePos.top;
  });

  var worldEl = $("#" + stageId + " world").first();

  // ---------------------------------------------------

  var tileWidth = cfg.consts.tile.width;
  var tileHeight = cfg.consts.tile.height;
  var tileWidth2 = tileWidth * 0.5;
  var tileHeight2 = tileHeight * 0.5;

  var viewWidth = cfg.consts.view.width;
  var viewHeight = cfg.consts.view.height;

  var mapRows = _.compact(cfg.maps[mapName].map.split("\n"));
  var numRows = mapRows.length;
  var numCols = _.max(mapRows, function(row) { return row.length; }).length;

  var mapWidth = tileWidth * numCols;
  var mapHeight = tileHeight * numRows;

  var startCol = -1;
  var startRow = 0;
  while (startRow < numRows) {
    startCol = mapRows[startRow].indexOf('S');
    if (startCol >= 0) {
      break;
    }
    startRow++;
  }
  if (startCol < 0 || startRow >= numRows) {
    console.log("could not find start point", mapName);
    return
  }

  var px = (startCol * 1.0) + 0.5;
  var py = (startRow * 1.0) + 0.5;

  var pxMid = mapWidth / 2;
  var pyMid = mapHeight / 2;

  var dirCmds = { 'up': [0, -1], 'down': [0, 1], 'left': [-1, 0],'right': [1, 0] };

  function onMoved() {
    for (var k in curKeys) {
      var dir = dirCmds[cmdKeys[k]];
      if (dir) {
        px = Math.min(Math.max(-pxMid, px + dir[0] * tileWidth2), pxMid);
        py = Math.min(Math.max(-pyMid, py + dir[1] * tileHeight2), pyMid);

        worldEl.velocity("finish").velocity({
          left: -px + "px", top: -py + "px"
        }, {
          duration: 100, complete: onMoved
        });
      }
    }
  }

  curKeysChanged.push(onMoved);

  // ---------------------------------------------------

  for (var r = 0; r < numRows; r++) {
    for (var c = 0; c < numCols; c++) {
      var tile = $("<tile/>");
      tile.attr("id", "t" + r + '-' + c);
      tile.css("top", r * tileWidth + "px");
      tile.css("left", c * tileHeight + "px");
      tile.text(mapRows[r].charAt(c));
      tile.appendTo($("#" + stageId + " world tiles"));
    }
  }

  for (var i = 0; i < 20; i++) {
    var r = $("<critter/>");
    r.attr("id", 'c' + i);
    r.css("background-color", "#" + Math.floor((Math.random() * 999)));
    r.appendTo($("#" + stageId + " world critters"));
    r.velocity({
      top: Math.random() * 400 + "px",
      left: Math.random() * 800 + "px",
    }, {
      loop: true,
      duration: 2000,
      easing: "easeInCubic",
    });
  }

  for (var i = 0; i < 1; i++) {
    var b = $("<bolt/>");
    b.attr("id", 'b' + i);
    b.css("background-color", "red");
    b.appendTo($("#" + stageId + " world bolts"));
    bolt(b,
      {top: "100px", left: "100px"},
      {top: "400px", left: "700px"},
      function(b) {
        var rv = function() {
          var worldPos = worldEl.position();
          bolt(b, {top: "100px",
                   left: "100px"},
                  {top: stagePointerY - worldPos.top,
                   left: stagePointerX - worldPos.left},
                  rv);
        };
        return rv;
      }(b))
  }
}

function bolt(b, from, to, complete) {
  b.velocity({
    top: [to.top, from.top],
    left: [to.left, from.left],
    rotateZ: ["1080deg", 0],
  }, {
    duration: 900,
    easing: "easeInCubic",
    complete: complete
  });
}
</script>

<style>
.main {
  height: 500px;
}
.main-TEST {
  transform: perspective(1000px) rotateX(20deg);
}
stage, stage * {
  position: absolute;
  display: block;
}
stage {
  width: 600px;
  height: 300px;
  overflow: hidden;
}
tile {
  width: 20px;
  height: 20px;
  border: 1px solid #aad;
  background-color: #eea;
}
critter {
  width: 15px;
  height: 15px;
}
bolt {
  width: 10px;
  height: 80px;
  border-radius: 10px;
}
</style>
</html>
